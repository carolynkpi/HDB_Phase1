---
title: "Singapore HDB Flat Resale Price Analysis - Part 2"
author: "Carolyn Koay"
date: "22 January 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Exploratory Data Analysis
The visualizations here are meant for exploratory purposes. 
<br>
Formatting and labelling are done just enough for initial exploration. 
Many charts are created in loops, repeating over a list of variables. 
Please forgive the formatting as customization to every variable is time-consuming and not efficient for EDA. Thank you. 

The exploration follows this structure: 

  1. Univariate distributions
    + Numeric variables
    + Categorical variables
    
  2. Bivariate distributions
    + Categorical vs categorical
    + Numeric vs categorical
    + Numeric vs numeric
  
  3. Multivariate distributions
  
  4. Trend over time
    + General trend
    + Trend split by categorical variables
  
  5. Aggregate 

Libraries used include dplyr, ggplot2, grid and gtable. 
```{r echo = FALSE, warning = FALSE, message = FALSE}
library(dplyr)
library(ggplot2)
library(grid)
library(gtable)

#### EDA ####
load('cleaned_data')

# pareto function ####
pareto = function(data, cat_var, xlab=NA, ylab = 'Frequency'){
  if (!cat_var %in% names(data)){return('Error: Variable not found in data frame')}
  if (!is.factor(data[[cat_var]])){return('Error: Variable is not factor type')}
  
  if (is.na(xlab)){xlab=cat_var}
  dt= as.data.frame(sort(table(data[cat_var], dnn=xlab), decreasing=TRUE), responseName = ylab)
  q = ggplot(dt,aes_string(xlab,ylab)) + geom_bar(stat='identity') 
  q = q + theme(axis.text.x = element_text(angle = 90, hjust = 1))
  print(q)
}

# ctable_graph function ####
ctable_graph = function(dt,rowlab="row", collab="col"){
  x = 1:ncol(dt)
  y = 1:nrow(dt)
  centers <- expand.grid(y,x)
  par(mar = c(3,13,8,1))
  colfunc <- colorRampPalette(c("aliceblue","blue"))
  image(x, y, t(dt),
        col = colfunc(as.integer(max(dt)/10)+1),
        breaks = seq(0,as.integer(max(dt)/10)*10+10,10),
        xaxt = 'n', 
        yaxt = 'n', 
        xlab = '', 
        ylab = '',
        ylim = c(max(y) + 0.5, min(y) - 0.5),
  )
  text(centers[,2], centers[,1], c(dt), col= "black")
  mtext(attributes(dt)$dimnames[[2]], at=1:ncol(dt), padj = -1, las = 2)
  mtext(attributes(dt)$dimnames[[1]], at=1:nrow(dt), side = 2, las = 1, adj = 1.2)
  abline(h=y + 0.5)
  abline(v=x + 0.5)
  mtext(paste("Contingency table of",rowlab,"vs", collab ,sep=" "),side=1,font=2)
  #title(main= paste("Contingency table of",rowlab,"vs", collab ,sep=" "))
}




```

We can explore all the factors and numeric data, 
```{r}
# identify categorical and numerical variables ####
fac = vector()
num = vector()
for(i in names(data)){
  fac[i] = is.factor(data[[i]]) 
  num[i] = is.numeric(data[[i]])
}
fac_var = names(data)[fac]
num_var = names(data)[num]
remove(fac,num)
```
or we can put some subjective judgement to select some useful variables only.  
```{r}
#Manual overwrite
fac_var = c('region', 'town','flat_type','flat_model','storey_range','age_bin', 'sqft_bin', 'resale_price_bin', "price_psf_bin")
num_var = c('resale_price','floor_area_sqft','age','price_per_sqft')
```
<br>

### 1. Univariate distributions

__Numerical data __

To combine and align a histogram with a boxplot, the following coding strategy was taken from <http://wresch.github.io/2014/05/22/aligning-ggplot2-graphs.html>.
```{r warning = FALSE, message = FALSE}
for(i in num_var){
  h = ggplotGrob(qplot(data[[i]],main = i, xlab=NULL)+geom_vline(xintercept=mean(data[[i]]),col='red') + scale_x_continuous(limits=c(min(data[[i]]), max(data[[i]]))))
  b = ggplotGrob(qplot('',data[[i]], xlab = NULL, ylab =NULL, geom='boxplot')+coord_flip()+ scale_y_continuous(limits=c(min(data[[i]]), max(data[[i]]))))
  maxwidths <- grid::unit.pmax(h$widths[2:5], b$widths[2:5])
  h$widths[2:5] <- as.list(maxwidths)
  b$widths[2:5] <- as.list(maxwidths)
  g <- gtable_matrix(name = i,
                     grobs = matrix(list(h, b), nrow = 2), 
                     widths = unit(6.5, "in"),
                     heights = unit(c(2.8, 0.7), "in"))
  grid.newpage()
  grid.draw(g)
}
```
```{r echo = FALSE}
remove(h,b,g, maxwidths)
```

__Categorical data__

```{r echo = FALSE}
for(i in fac_var){
  pareto(data,i)
}
```

<br>

### 2. Bivariate distributions

__Categorical vs Categorical__

```{r echo = FALSE, fig.width = 15, fig.height=10}
#cat-cat ####
for(i in seq(1,length(fac_var),1)){
  if (i == length(fac_var)){break}
  for(j in seq(i+1,length(fac_var),1)){
    ctable_graph(table(data[[fac_var[i]]],data[[fac_var[j]]]),fac_var[i],fac_var[j])
  }
}
```

__Numeric vs Categorical__

```{r echo = FALSE}
# num-cat ####
for(i in seq(1, length(fac_var),1)){
  for(j in seq(1,length(num_var),1))
    print(qplot(data[[fac_var[i]]],data[[num_var[j]]],geom='boxplot',xlab=fac_var[i],ylab=num_var[j]) + theme(axis.text.x = element_text(angle = 90, hjust = 1)))
}

```

__Numeric vs Numeric__

```{r echo = FALSE}
# num-num ####
for(i in seq(1, length(num_var),1)){
  if(i==length(num_var)){break}
  for(j in seq(i+1, length(num_var),1)){
    print(qplot(data[[num_var[i]]],data[[num_var[j]]],xlab=num_var[i],ylab=num_var[j]))
  }
}
```

<br>

### 3. Multivariate distributions
<br>

### 4. Trend over time 

__General__

```{r echo = FALSE}
# General trend ####
ggplot(data, aes(x=date, y=resale_price)) +
  stat_summary(fun.y = "mean", 
               aes(colour="mean"), 
               geom='line') +
  geom_smooth(method='lm',color = 'red', se=FALSE) +
  stat_summary(fun.y = "median", 
               aes(colour="median"), 
               geom='line') +
  geom_smooth(mapping = aes(x = date,median(resale_price)),method='lm',color = 'blue') +
  scale_colour_manual('',values=c("mean"="red", "median"="blue")) + 
  labs(title ='Resale prices over time')

ggplot(data, aes(x=date, y=price_per_sqft)) +
  stat_summary(fun.y = "mean",
               aes(colour="mean"), 
               geom='line') +
  geom_smooth(method='lm',color = 'red', se=FALSE) +
  stat_summary(fun.y = "median", 
               aes(colour="median"), 
               geom='line') +
  geom_smooth(mapping = aes(x = date,median(price_per_sqft)),method='lm',color = 'blue') +
  scale_colour_manual('',values=c("mean"="red", "median"="blue")) + 
  labs(title ='Prices per sqft over time')

```

__Split by categorical variable__

```{r echo = FALSE}
# Split trend by categorical variable (using mean) ####
for(i in fac_var){
  temp = as.data.frame(data 
                       %>% group_by_(.dots=c(i,'date'))
                       %>% summarise(mean_resale_price = mean(resale_price)))
  g = ggplot(temp, aes(date, mean_resale_price))
  g = g + geom_line(aes_string(color=i))
  print(g)
}
```
```{r echo = FALSE}
remove(temp)
```
<br>

### 5. Aggregates
```{r echo = FALSE}
for(i in fac_var){
  temp = as.data.frame(data[c(i,num_var)]
                       %>% group_by_(i)
                       %>% summarise_all(funs(mean)))
  for(j in num_var){
    if(i %in% c('region','town','flat_model')){
      g =ggplot(data = temp, aes_string(x=reorder(temp[[i]],temp[[j]], function(x)-mean(x)), y=j))
    }else{
      g =ggplot(data = temp, aes_string(x=i, y=j))
      }
    g = g + 
      geom_bar(stat='identity') + 
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
      labs(x=i)
    print(g)
  }    
}
```